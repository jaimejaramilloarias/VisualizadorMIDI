<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Visualizador MIDI - Jaime Jaramillo Arias</title>
  <link rel="stylesheet" href="styles.css" />
  <link
    rel="icon"
    type="image/svg+xml"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' ry='12' fill='%23000'/%3E%3Ctext x='32' y='42' font-family='Arial' font-size='32' text-anchor='middle' fill='%23fff'%3EM%3C/text%3E%3C/svg%3E"
  />
</head>
<body>
  <div id="app-container">
    <header class="app-header">
      <div class="title-wrapper">
        <h1 id="app-title">Visualizador MIDI - Jaime Jaramillo Arias</h1>
        <p id="app-subtitle">Basado en el "Music Animation Machine" de Stephen Malinowski.</p>
      </div>
    </header>

    <div id="workspace">
      <aside id="control-sidebar">
        <div class="control-dock">
          <div class="control-card hero-block">
            <div class="card-header">
              <div class="card-title">Acciones rápidas</div>
              <p class="card-subtitle">Carga, reproduce y reinicia sin perder el contexto.</p>
            </div>
            <div class="pill-grid">
              <button
                id="load-midi"
                title="Cargar archivo MIDI"
                data-help="Selecciona un archivo MIDI local para visualizar sus notas."
              >Cargar MIDI</button>
              <button
                id="load-wav"
                title="Cargar archivo WAV"
                data-help="Carga un archivo WAV y sincroniza el audio con la animación."
              >Cargar WAV</button>
              <button
                id="refresh-animation"
                title="Refrescar animación"
                data-help="Reinicia el motor de animación sin perder el audio, el MIDI ni las preferencias."
              >Refrescar</button>
              <button
                id="play-stop"
                class="accent-button"
                title="Reproducir o detener"
                data-help="Inicia o detiene la reproducción de la animación y el audio cargado."
              >Play/Stop</button>
            </div>
          </div>

          <div class="tabbed-card" data-tab-group="primary-tabs">
            <div class="tab-header">
              <button class="tab-trigger active" data-tab-target="playback">Transporte</button>
              <button class="tab-trigger" data-tab-target="visual">Pantalla</button>
              <button class="tab-trigger" data-tab-target="extras">Herramientas</button>
            </div>
            <div class="tab-panels">
              <div class="tab-panel active" data-tab-panel="playback">
                <div class="summary-title">Transporte y navegación</div>
                <p class="summary-subtitle">Atajos rápidos y reinicio inmediato.</p>
                <div class="button-matrix tight-grid">
                  <button
                    id="seek-backward-arrow"
                    class="icon-button"
                    title="Retroceder reproducción"
                    aria-label="Retroceder"
                    data-help="Retrocede rápidamente utilizando un control en forma de flecha."
                  >&#9664;</button>
                  <button
                    id="seek-backward"
                    title="Atrasar 3 segundos"
                    data-help="Retrocede la reproducción tres segundos."
                  >Atrasar</button>
                  <button
                    id="restart"
                    title="Reiniciar"
                    data-help="Regresa la reproducción al inicio."
                  >Inicio</button>
                  <button
                    id="seek-forward"
                    title="Adelantar 3 segundos"
                    data-help="Avanza la reproducción tres segundos."
                  >Adelantar</button>
                  <button
                    id="seek-forward-arrow"
                    class="icon-button"
                    title="Avanzar reproducción"
                    aria-label="Avanzar"
                    data-help="Avanza rápidamente utilizando un control en forma de flecha."
                  >&#9654;</button>
                  <button
                    id="tap-tempo-mode"
                    data-action="tap-tempo"
                    class="accent-button"
                    title="Modo tap tempo"
                    data-help="Accede a las herramientas de tap tempo para definir el mapa de tempo a partir del audio."
                  >Modo tap tempo</button>
                </div>
              </div>

              <div class="tab-panel" data-tab-panel="visual">
                <div class="summary-title">Visualización y formato</div>
                <p class="summary-subtitle">Aspecto del lienzo y sincronización con tu pantalla.</p>
                <div class="control-grid grid-3 compact-grid">
                  <button
                    id="aspect-16-9"
                    title="Cambiar a 16:9"
                    data-help="Establece el canvas en formato horizontal 16:9."
                  >16:9</button>
                  <button
                    id="full-screen"
                    title="Pantalla completa"
                    data-help="Expande el canvas a pantalla completa con supersampling."
                  >Pantalla completa</button>
                  <button
                    id="aspect-9-16"
                    title="Cambiar a 9:16"
                    data-help="Establece el canvas en formato vertical 9:16."
                  >9:16</button>
                </div>
                <div
                  id="fps-control-group"
                  class="fps-control"
                  data-help="Selecciona si la animación sigue la frecuencia de actualización de tu pantalla o usa un valor fijo."
                >
                  <label for="fps-mode">Modo de FPS</label>
                  <select
                    id="fps-mode"
                    title="Define cómo se sincroniza la animación con la pantalla"
                  >
                    <option value="auto">Automático (según pantalla)</option>
                    <option value="fixed">Fijo</option>
                  </select>
                  <label for="fps-value">FPS fijos</label>
                  <input
                    type="number"
                    id="fps-value"
                    min="30"
                    max="240"
                    step="1"
                    value="90"
                    title="Especifica los fotogramas por segundo cuando se usa el modo fijo"
                  />
                </div>
              </div>

              <div class="tab-panel" data-tab-panel="extras">
                <div class="summary-title">Herramientas adicionales</div>
                <p class="summary-subtitle">Accesos directos a configuraciones avanzadas.</p>
                <nav id="bottom-menu">
                  <button
                    id="open-family-shortcut"
                    data-window-target="family-window"
                    title="Ir al panel de familias"
                    data-help="Abre la ventana de familias y despliega sus controles detallados."
                  >Familias</button>
                  <button
                    id="tap-tempo-mode-secondary"
                    data-action="tap-tempo"
                    title="Modo tap tempo"
                    data-help="Accede a las herramientas de tap tempo para definir el mapa de tempo a partir del audio."
                  >Tap tempo</button>
                </nav>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <section id="visual-section">
        <div class="visual-shell">
          <div class="canvas-header">
            <div class="badge">Lienzo activo</div>
            <p class="canvas-hint">Controla la reproducción y el formato desde el panel superior.</p>
          </div>
          <div class="canvas-wrapper">
            <canvas
              id="visualizer"
              width="1280"
              height="720"
              title="Área de visualización"
              data-help="Muestra la animación de las notas del archivo MIDI."
            ></canvas>
          </div>
        </div>

        <div class="advanced-stage tabbed-card" data-tab-group="advanced-tabs">
          <div class="tab-header subtle compact-tabs">
            <div class="tab-group-label">
              <span class="tiny-label">Avanzado</span>
              <strong>Paneles flotantes</strong>
            </div>
            <div class="tab-trigger-row">
              <button class="tab-trigger active" data-tab-target="familias">Familias</button>
              <button class="tab-trigger" data-tab-target="tap">Tap tempo</button>
            </div>
          </div>
          <div class="tab-panels">
            <div class="tab-panel active" data-tab-panel="familias">
              <div class="micro-card">
                <div>
                  <div class="summary-title">Color y forma</div>
                  <p class="summary-subtitle">Personaliza familias en una ventana dedicada.</p>
                </div>
                <div class="chip-row">
                  <button
                    id="open-family-panel"
                    class="chip-button"
                    data-window-target="family-window"
                    title="Abrir panel de familias"
                    data-help="Abre una ventana flotante para ajustar color, forma y asignaciones de cada familia."
                  >Abrir panel</button>
                  <button
                    id="toggle-family-panel"
                    class="chip-button ghost"
                    data-window-target="family-window"
                    data-window-mode="toggle"
                    title="Mostrar u ocultar el panel"
                    data-help="Despliega u oculta la ventana de familias sin perder la configuración."
                  >▼</button>
                </div>
              </div>
              <div class="micro-grid">
                <div class="micro-card muted">
                  <p class="micro-title">Atajos rápidos</p>
                  <p class="micro-text">Asigna familias desde el modal de instrumentos y conserva tus combinaciones favoritas.</p>
                </div>
                <div class="micro-card muted">
                  <p class="micro-title">Visual compacto</p>
                  <p class="micro-text">Los controles se agrupan por secciones para evitar desbordes y mantener todo visible.</p>
                </div>
              </div>
            </div>

            <div class="tab-panel" data-tab-panel="tap">
              <div class="micro-card">
                <div>
                  <div class="summary-title">Mapa de tempo</div>
                  <p class="summary-subtitle">Pulsa y ajusta marcadores sin salir del lienzo.</p>
                </div>
                <div class="chip-row">
                  <button
                    id="tap-tempo-mode-tertiary"
                    data-action="tap-tempo"
                    class="chip-button"
                    data-window-target="tap-window"
                    title="Abrir herramientas de tap tempo"
                    data-help="Activa las herramientas de tap tempo en una ventana flotante."
                  >Abrir tap tempo</button>
                  <button
                    class="chip-button ghost"
                    data-window-target="tap-window"
                    data-window-mode="toggle"
                    title="Mostrar u ocultar la ventana de tap tempo"
                  >▼</button>
                </div>
              </div>
              <div class="micro-grid">
                <div class="micro-card muted">
                  <p class="micro-title">Modo guiado</p>
                  <p class="micro-text">Los mensajes de ayuda se alinean al cursor y se mantienen dentro de la ventana.</p>
                </div>
                <div class="micro-card muted">
                  <p class="micro-title">Edición segura</p>
                  <p class="micro-text">Los marcadores se ordenan automáticamente para evitar solapamientos accidentales.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div id="family-window" class="floating-window hidden">
      <div class="window-shell">
        <div class="window-header">
          <div>
            <p class="window-eyebrow">Ajustes avanzados</p>
            <p class="window-title">Panel de familias</p>
            <p class="window-subtitle">Colores, formas y asignaciones en un espacio separado.</p>
          </div>
          <div class="window-actions">
            <button class="chip-button ghost" data-close-window="family-window" aria-label="Cerrar panel">×</button>
          </div>
        </div>
        <div class="window-body">
          <div id="family-config-panel">
            <div id="developer-controls"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="tap-window" class="floating-window hidden">
      <div class="window-shell">
        <div class="window-header">
          <div>
            <p class="window-eyebrow">Sincronía</p>
            <p class="window-title">Tap tempo y mapa</p>
            <p class="window-subtitle">Pulsa, corrige marcadores y refina el tempo en un panel limpio.</p>
          </div>
          <div class="window-actions">
            <button class="chip-button ghost" data-close-window="tap-window" aria-label="Cerrar tap tempo">×</button>
          </div>
        </div>
        <div class="window-body">
          <div class="tap-window-intro">
            <p>Inicia la captura para ver la forma de onda y manipular los marcadores sin tapar el lienzo principal.</p>
          </div>
          <div id="tap-tempo-panel" class="hidden">
            <div id="tap-tempo-controls">
              <button
                id="start-tap-tempo"
                title="Iniciar captura de tap tempo"
                data-help="Reproduce el audio desde el inicio y registra tus pulsos con cualquier tecla."
              >Iniciar tap tempo</button>
              <button
                id="stop-tap-tempo"
                title="Detener o reiniciar el proceso de tap tempo"
                data-help="Detiene la captura en curso o restaura el mapa de tempo original sin necesidad de volver a cargar el audio."
              >Reiniciar proceso tap tempo</button>
              <p id="tap-tempo-status">
                Carga un archivo WAV y utiliza el tap tempo para crear un mapa de tempo personalizado. Usa Alt+clic para añadir marcadores,
                muévelos desde el punto superior con las flechas y elimínalos desde el punto inferior.
              </p>
            </div>
            <div id="tap-tempo-editor" class="hidden">
              <div class="tap-tempo-toolbar">
                <label>
                  Zoom
                  <input
                    type="range"
                    id="tap-zoom"
                    min="0"
                    max="100"
                    value="0"
                    title="Ajusta la cantidad de audio visible en la forma de onda"
                  />
                </label>
                <label>
                  Posición
                  <input
                    type="range"
                    id="tap-position"
                    min="0"
                    max="100"
                    value="0"
                    title="Desplaza la ventana visible de la forma de onda"
                  />
                </label>
                <button
                  id="tap-marker-add"
                  type="button"
                  title="Agregar un nuevo marcador (también disponible con Alt+clic)"
                >Agregar marcador</button>
                <button
                  id="tap-marker-delete"
                  type="button"
                  title="Eliminar el marcador seleccionado"
                >Eliminar marcador</button>
              </div>
              <canvas
                id="tap-waveform"
                width="1200"
                height="360"
                title="Forma de onda del audio con marcadores de tempo"
              ></canvas>
              <p class="tap-tempo-hint">
                Arrastra cada marcador desde el punto superior con las flechas dobles para reubicarlo. Usa Alt+clic en la forma de onda para añadir nuevos marcadores y haz clic en el punto inferior con el signo menos para eliminarlo.
              </p>
            </div>
            <div id="tap-tooltip" class="tooltip hidden"></div>
          </div>
        </div>
      </div>
    </div>

    <input
      type="file"
      id="midi-file-input"
      accept=".mid,.midi"
      style="display: none"
    />

    <input
      type="file"
      id="wav-file-input"
      accept=".wav,audio/wav"
      style="display: none"
    />
  </div>

  <div id="assignment-modal" class="hidden">
    <div class="modal-content">
      <div class="modal-columns">
        <div class="instruments-column">
          <h3>Instrumentos</h3>
          <ul id="modal-instrument-list"></ul>
        </div>
        <div class="families-column">
          <h3>Familias</h3>
          <div id="modal-family-zones"></div>
        </div>
      </div>
      <button
        id="apply-assignments"
        title="Aplicar asignaciones"
        data-help="Confirma las asignaciones de instrumentos a familias."
      >Aplicar</button>
    </div>
  </div>

  <script src="utils.js"></script>
  <script src="midiLoader.js"></script>
  <script src="wavLoader.js"></script>
  <script src="audioPlayer.js"></script>
  <script src="ui.js"></script>
  <script src="help.js"></script>
  <script src="configuracion.js"></script>
  <script src="script.js"></script>
</body>
</html>
